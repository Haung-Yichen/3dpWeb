<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ“æ§ä»‹é¢</title>
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --accent-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-bg: #111827;
            --dark-surface: #1f2937;
            --dark-card: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4b5563;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", "Segoe UI", "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* å´é‚Šæ¬„ */
        .sidebar {
            width: 280px;
            background: var(--dark-surface);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
            transform: translateX(-100%); /* é è¨­éš±è— */
        }

        .sidebar.open {
            transform: translateX(0); /* å±•é–‹ */
        }
        
        .sidebar.collapsed {
            transform: translateX(-100%); /* æ”¶èµ· */
        }

        .sidebar-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .logo-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .nav-section {
            margin-bottom: 30px;
        }

        .nav-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            text-decoration: none;
        }

        .nav-item:hover {
            background: var(--dark-card);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--primary-color);
            color: var(--text-primary);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            opacity: 0.7;
        }

        /* è¨­å®šè¦–çª—é®ç½© */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .settings-overlay.show {
            display: flex;
        }

        /* è¨­å®šè¦–çª— */
        .settings-modal {
            background: var(--dark-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .settings-modal h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .ip-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .ip-input-container span {
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .ip-input-container input[type="number"] {
            width: 70px;
            padding: 10px;
            font-size: 1rem;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--dark-surface);
            color: #10b981;
            font-weight: 600;
        }

        .ip-input-container input[type="number"]:focus {
            border-color: var(--secondary-color);
            outline: none;
        }

        .settings-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .settings-buttons button {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        /* ä¸»å…§å®¹å€ */
        .main-content {
            flex: 1;
            margin-left: 0; /* é è¨­ margin-left ç‚º 0 */
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 280px; /* å´é‚Šæ¬„å±•é–‹æ™‚çš„ margin */
        }

        /* å´é‚Šæ¬„åˆ‡æ›æŒ‰éˆ• */
        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px; /* é è¨­ä½ç½® */
            z-index: 2001;
            background: var(--dark-surface);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: left 0.3s ease, background 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .sidebar-toggle:hover {
            background: var(--dark-card);
            border-color: var(--secondary-color);
        }

        /* å´é‚Šæ¬„å±•é–‹æ™‚ï¼ŒæŒ‰éˆ•çš„ä½ç½® */
        .sidebar-toggle.sidebar-open {
            left: 300px;
        }

        .sidebar-toggle svg {
            width: 20px;
            height: 20px;
            color: var(--text-primary);
        }

        /* å´é‚Šæ¬„èƒŒæ™¯é®ç½© (æ‰‹æ©Ÿç‰ˆ) */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1999;
        }

        .sidebar-overlay.show {
            display: block;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger-color);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--accent-color);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* å„€è¡¨æ¿ç¶²æ ¼ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%); /* æ‰‹æ©Ÿç‰ˆé è¨­éš±è— */
                z-index: 2000;
            }
            
            .sidebar.open {
                transform: translateX(0); /* æ‰‹æ©Ÿç‰ˆå±•é–‹ */
            }
            
            .sidebar.collapsed {
                transform: translateX(-100%); /* æ‰‹æ©Ÿç‰ˆæ”¶èµ· */
            }
            
            .main-content {
                margin-left: 0 !important;
                padding: 10px;
            }
            .main-content.expanded {
                margin-left: 0 !important;
            }
            .dashboard-grid {
                grid-template-columns: 1fr; /* æ”¹ç‚ºå–®æ¬„ä½ˆå±€ */
                gap: 10px;
            }
            .card {
                padding: 12px;
                min-width: 0; /* å…è¨± flex/grid é …ç›®ç¸®å° */
            }
            .card-header {
                margin-bottom: 12px;
            }
            .card-title {
                font-size: 0.95rem;
            }
            .page-title {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
            /* èª¿æ•´æŒ‰éˆ•å®¹å™¨åœ¨å°è¢å¹•çš„è¡¨ç¾ - ä¿æŒæŒ‰éˆ•ä¸¦æ’é¡¯ç¤º */
            .buttons-container {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }
            .buttons-container button {
                flex: 0 1 calc(50% - 6px); /* è®“æŒ‰éˆ•å¹³å‡åˆ†é…ä¸¦ä¿æŒä¸¦æ’ */
                min-width: 140px;
            }
            .buttons-container input[type="number"] {
                flex: 1 1 100%; /* è¼¸å…¥æ¬„ä½å–®ç¨å ä¸€åˆ—è¼ƒæ˜“é–±è®€ */
            }
            /* æŒ‰éˆ•å°ºå¯¸ç¸®å° */
            button {
                padding: 8px 10px;
                font-size: 12px;
                min-height: 36px;
            }
            /* è¼¸å…¥æ¡†å°ºå¯¸ç¸®å° */
            input[type="number"] {
                padding: 8px 10px;
                font-size: 12px;
            }
        }

        .card {
            background: var(--dark-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-icon {
            width: 24px;
            height: 24px;
            opacity: 0.7;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .buttons-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .buttons-container {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .buttons-container button {
                flex: 1 1 calc(50% - 8px);
                min-width: 140px;
            }

            .buttons-container input[type="number"] {
                flex: 1 1 calc(50% - 8px);
                min-width: 140px;
            }
        }

        button {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--dark-surface);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 40px;
        }

        button:hover {
            background: var(--dark-bg);
            border-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        /* æŒ‰éˆ•é¡è‰²è®Šé«” */
        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1e40af;
            border-color: #1e40af;
        }

        .btn-success {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            border-color: #059669;
        }

        .btn-warning {
            background: var(--warning-color);
            border-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            border-color: #d97706;
        }

        .btn-danger {
            background: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input[type="number"] {
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--dark-surface);
            color: #000000;
            transition: all 0.2s ease;
            outline: none;
            width: 100%;
        }

        input[type="number"]:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* è½‰åœˆåœˆå‹•ç•« */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: var(--accent-color);
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ä¸Šå‚³é€²åº¦å®¹å™¨ */
        #uploadProgressContainer {
            display: none;
            margin-top: 15px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }


        .status-value {
            color: var(--accent-color);
            font-weight: 600;
        }

        /* é€²åº¦æ¢ */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--dark-surface);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        /* æº«åº¦é¡¯ç¤º */
        .temp-display {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background: var(--dark-surface);
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            min-width: 80px;
        }

        .temp-display.hot {
            color: var(--danger-color);
        }

        .temp-display.warm {
            color: var(--warning-color);
        }

        .temp-display.cool {
            color: var(--secondary-color);
        }

        /* è¦–è¨Šå®¹å™¨ */
        .camera-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #cameraStream {
            max-width: 100%;
            height: auto;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        #cameraStream:hover {
            border-color: var(--secondary-color);
        }

        #cameraStatus {
            margin-top: 12px;
            padding: 8px 16px;
            background: var(--dark-surface);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: inline-block;
        }

        /* ç›£æ§è¦–çª— */
        #monitorWindow {
            background: var(--dark-surface);
            border-radius: 8px;
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
        }

        #uploadStatus {
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 8px;
        }

        #connectionStatus {
            color: var(--warning-color);
            font-weight: 600;
            margin-bottom: 8px;
        }

        #espMessage {
            color: var(--accent-color);
            font-weight: 600;
        }

        /* æª”æ¡ˆåç¨±é¡¯ç¤º */
        #fileName {
            margin-top: 15px;
            padding: 12px;
            background: var(--dark-surface);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            color: var(--text-secondary);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1024px) {
            .sidebar-toggle {
                display: flex;
                left: 20px !important; /* æ‰‹æ©Ÿç‰ˆé è¨­ä½ç½® */
            }

            .sidebar-toggle.sidebar-open {
                left: 300px !important; /* æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„æ‰“é–‹æ™‚ */
            }
        }

        input[type="number"] {
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            outline: none;
        }

        input[type="number"]:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        #fileName {
            margin-top: 15px;
            font-size: 16px;
            color: #667eea;
            text-align: center;
            font-weight: 600;
            padding: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
        }

        #monitorWindow {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            font-size: 14px;
            color: #15c0cc;
            line-height: 1.8;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        #uploadStatus {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
        }

        #connectionStatus {
            color: #ff9800;
            font-weight: 600;
            margin-bottom: 8px;
        }

        #espMessage {
            color: #4CAF50;
            font-weight: 600;
        }

        #fileInput {
            display: none;
        }

        .temp-display {
            min-width: 120px;
            text-align: center;
            font-weight: 700;
            font-size: 16px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .temp-display:hover {
            background: white;
            border-color: rgba(102, 126, 234, 0.3);
        }

        #nozzleTempDisplay {
            color: #4CAF50;
        }

        #bedTempDisplay {
            color: #f44336;
        }

        #filamentWeightDisplay {
            color: #9c27b0;
        }

        #remainingTimeDisplay {
            color: #ff5722;
        }

        #progressDisplay {
            color: #009688;
        }

        #startCameraButton {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        #startCameraButton:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        #stopCameraButton {
            background: linear-gradient(135deg, #f44336, #e53935);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        #stopCameraButton:hover {
            background: linear-gradient(135deg, #e53935, #d32f2f);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .camera-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #cameraStream {
            max-width: 100%;
            height: auto;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        #cameraStream:hover {
            border-color: rgba(102, 126, 234, 0.4);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        #cameraStatus {
            color: #666;
            font-size: 14px;
            margin-top: 12px;
            font-weight: 500;
            padding: 8px 16px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 20px;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                max-width: 100%;
            }

            .control-panel {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2rem;
            }

            .buttons-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- å´é‚Šæ¬„èƒŒæ™¯é®ç½© (æ‰‹æ©Ÿç‰ˆ) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    
    <div class="app-container">
        <!-- å´é‚Šæ¬„ -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">3D Print Hub</div>
                <div class="logo-subtitle">å°ˆæ¥­åˆ—å°æ§åˆ¶ä¸­å¿ƒ</div>
            </div>

            <div class="nav-section">
                <div class="nav-title">ä¸»è¦åŠŸèƒ½</div>
                <a href="#temperature" class="nav-item" onclick="scrollToSection('temperature')">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" />
                    </svg>
                    æº«åº¦ç›£æ§
                </a>
                <a href="#print-status" class="nav-item" onclick="scrollToSection('print-status')">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" />
                    </svg>
                    åˆ—å°ç‹€æ…‹
                </a>
                <a href="#print-control" class="nav-item" onclick="scrollToSection('print-control')">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                        <path fill-rule="evenodd"
                            d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" />
                    </svg>
                    åˆ—å°æ§åˆ¶
                </a>
                <a href="#video" class="nav-item" onclick="scrollToSection('video')">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" />
                    </svg>
                    è¦–è¨Šç›£æ§
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">ç³»çµ±</div>
                <a href="#" class="nav-item" onclick="showSettings(); return false;">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" />
                    </svg>
                    è¨­å®š
                </a>
                <a href="#" class="nav-item" onclick="showQRCode(); return false;">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                    </svg>
                    é€£çµ
                </a>
                <a href="#" class="nav-item" onclick="showAbout(); return false;">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" />
                    </svg>
                    èªªæ˜
                </a>
            </div>
        </div>

        <!-- åˆ‡æ›å´é‚Šæ¬„æŒ‰éˆ• -->
        <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
            <svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
            </svg>
        </button>

        <!-- ä¸»å…§å®¹å€ -->
        <div class="main-content" id="mainContent">
            <!-- é é¢æ¨™é¡Œ -->
            <div class="header">
                <h1 class="page-title">å°è¡¨æ©Ÿæ§åˆ¶</h1>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div class="status-indicator">
                        <div class="status-dot" id="connectionDot"></div>
                        <span id="connectionStatus">é€£ç·šä¸­...</span>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot" id="esp32Dot"></div>
                        <span id="esp32Status">ESP32 é€£ç·šä¸­...</span>
                    </div>
                </div>
            </div>

            <!-- å„€è¡¨æ¿ç¶²æ ¼ -->
            <div class="dashboard-grid">
                <!-- æº«åº¦ç›£æ§ -->
                <div class="card" id="temperature">
                    <div class="card-header">
                        <h3 class="card-title">æº«åº¦ç›£æ§</h3>
                        <svg class="card-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" />
                        </svg>
                    </div>
                    
                    <!-- æº«åº¦é¡¯ç¤ºå€åŸŸ -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: var(--dark-surface); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">å™´å˜´æº«åº¦</div>
                            <div id="nozzleTempDisplay" style="font-size: 24px; font-weight: 700; color: var(--accent-color);">-- Â°C</div>
                        </div>
                        <div style="background: var(--dark-surface); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">ç†±åºŠæº«åº¦</div>
                            <div id="bedTempDisplay" style="font-size: 24px; font-weight: 700; color: var(--danger-color);">-- Â°C</div>
                        </div>
                    </div>
                    
                    <!-- æº«åº¦è¨­å®š -->
                    <div class="buttons-container">
                        <input type="number" id="nozzleTempInput" placeholder="å™´å˜´æº«åº¦ (Â°C)" value="200">
                        <button id="setNozzleTempButton" class="btn-primary">è¨­å®šå™´å˜´</button>
                    </div>
                    <div class="buttons-container" style="margin-top: 10px;">
                        <input type="number" id="bedTempInput" placeholder="ç†±åºŠæº«åº¦ (Â°C)">
                        <button id="setBedTempButton" class="btn-primary">è¨­å®šç†±åºŠ</button>
                    </div>
                </div>

                <!-- åˆ—å°ç‹€æ…‹ -->
                <div class="card" id="print-status">
                    <div class="card-header">
                        <h3 class="card-title">åˆ—å°ç‹€æ…‹</h3>
                        <svg class="card-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" />
                        </svg>
                    </div>
                    
                    <!-- åˆ—å°é€²åº¦ -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px; color: var(--text-secondary);">åˆ—å°é€²åº¦</span>
                            <span id="progressDisplay" style="font-size: 18px; font-weight: 700; color: var(--accent-color);">-- %</span>
                        </div>
                        <div class="progress-bar">
                            <div id="printProgressBar" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- å…¶ä»–ç‹€æ…‹è³‡è¨Š -->
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--dark-surface); border-radius: 6px;">
                            <span style="color: var(--text-secondary);">è€—æé‡é‡</span>
                            <span id="filamentWeightDisplay" style="font-weight: 600; color: var(--text-primary);">-- g</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--dark-surface); border-radius: 6px;">
                            <span style="color: var(--text-secondary);">å‰©é¤˜æ™‚é–“</span>
                            <span id="remainingTimeDisplay" style="font-weight: 600; color: var(--text-primary);">-- min</span>
                        </div>
                    </div>
                </div>

                <!-- åˆ—å°æ§åˆ¶ -->
                <div class="card" id="print-control">
                    <div class="card-header">
                        <h3 class="card-title">åˆ—å°æ§åˆ¶</h3>
                        <svg class="card-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                        </svg>
                    </div>
                    <div class="buttons-container">
                        <button id="startPrintButton" class="btn-success">é–‹å§‹åˆ—å°</button>
                        <button id="pausePrintButton" class="btn-warning">æš«åœåˆ—å°</button>
                        <button id="cstopPrintingButton" class="btn-danger">åœæ­¢åˆ—å°</button>
                        <button id="homeButton" class="btn-primary">å›åŸé»</button>
                        <button id="emergencyStopButton" class="btn-danger"
                            style="background: #dc2626; border-color: #dc2626; font-weight: 700;">ç·Šæ€¥åœæ­¢</button>
                    </div>
                </div>

                <!-- æª”æ¡ˆç®¡ç† -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">æª”æ¡ˆç®¡ç†</h3>
                        <svg class="card-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" />
                        </svg>
                    </div>
                    <div class="buttons-container">
                        <button id="actionButton" class="btn-primary">é¸æ“‡æª”æ¡ˆ</button>
                        <button id="uploadButton" class="btn-success">ä¸Šå‚³æª”æ¡ˆ</button>
                    </div>
                    <input type="file" id="fileInput" accept=".gcode,.gco" />
                    <div id="fileName">æœªé¸æ“‡æª”æ¡ˆ</div>
                    
                    <!-- ä¸Šå‚³é€²åº¦é¡¯ç¤º -->
                    <div id="uploadProgressContainer">
                        <div class="progress-label">
                            <span id="uploadStatusText"><div class="spinner"></div>æ­£åœ¨ä¸Šå‚³...</span>
                            <span id="uploadPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="uploadProgressBar" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- è¦–è¨Šç›£æ§ -->
                <div class="card" id="video">
                    <div class="card-header">
                        <h3 class="card-title">è¦–è¨Šç›£æ§</h3>
                        <svg class="card-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path
                                d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
                        </svg>
                    </div>
                    <div class="camera-container">
                        <img id="cameraStream" src="" alt="ESP32-CAM è¦–è¨Šä¸²æµ" style="display: none;">
                        <div id="cameraStatus">é¡é ­æœªé–‹å•Ÿ</div>
                    </div>
                    <div class="buttons-container">
                        <button id="startCameraButton" class="btn-success">é–‹å•Ÿé¡é ­</button>
                        <button id="stopCameraButton" class="btn-danger">é—œé–‰é¡é ­</button>
                    </div>
                </div>

                <!-- ç³»çµ±ç‹€æ…‹ -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ç³»çµ±ç‹€æ…‹</h3>
                        <svg class="card-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" />
                        </svg>
                    </div>
                    <div id="monitorWindow">
                        <div id="uploadStatus">å°šæœªä¸Šå‚³æª”æ¡ˆ</div>
                        <div id="monitorConnectionStatus">æ­£åœ¨é€£æ¥åˆ° ESP32...</div>
                        <div id="espMessage"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sidebar logic
        document.addEventListener('DOMContentLoaded', function () {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            function updateLayout() {
                const isDesktop = window.innerWidth > 768;
                const isOpen = sidebar.classList.contains('open');

                if (isDesktop) {
                    // æ¡Œé¢æ¨¡å¼
                    // å´é‚Šæ¬„å±•é–‹æ™‚ï¼Œä¸»å…§å®¹è¦æœ‰å·¦é‚Šè·
                    mainContent.classList.toggle('expanded', isOpen);
                    // æ¡Œé¢æ¨¡å¼ä¸éœ€è¦é®ç½©
                    sidebarOverlay.classList.remove('show');
                } else {
                    // æ‰‹æ©Ÿæ¨¡å¼
                    // ä¸»å…§å®¹æ°¸é æ²’æœ‰å·¦é‚Šè·
                    mainContent.classList.remove('expanded');
                    // å´é‚Šæ¬„å±•é–‹æ™‚é¡¯ç¤ºé®ç½©
                    sidebarOverlay.classList.toggle('show', isOpen);
                }
                
                // æ›´æ–°æŒ‰éˆ•ä½ç½®
                sidebarToggle.classList.toggle('sidebar-open', isOpen);
            }

            function setInitialSidebarState() {
                // æ ¹æ“šè¦æ±‚ï¼Œé è¨­ç‚ºæ”¶èµ·ç‹€æ…‹
                sidebar.classList.remove('open');
                updateLayout();
            }

            // å®šç¾©å…¨åŸŸå‡½æ•¸ä¾› HTML onclick ä½¿ç”¨
            window.toggleSidebar = function () {
                sidebar.classList.toggle('open');
                updateLayout();
            };

            window.closeSidebar = function() {
                // æ‰‹æ©Ÿç‰ˆé»æ“Šé®ç½©é—œé–‰
                sidebar.classList.remove('open');
                updateLayout();
            };
            
            window.scrollToSection = function(sectionId) {
                const element = document.getElementById(sectionId);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth' });
                }
                // æ‰‹æ©Ÿç‰ˆé»æ“Šé€£çµå¾Œè‡ªå‹•é—œé–‰å´é‚Šæ¬„
                if (window.innerWidth <= 768) {
                    window.closeSidebar();
                }
            };

            // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
            window.addEventListener('resize', function() {
                // é€™è£¡å¯ä»¥åŠ å…¥æ›´ç´°ç·»çš„é‚è¼¯ï¼Œä¾‹å¦‚å¾æ‰‹æ©Ÿè½‰æ¡Œé¢æ™‚è‡ªå‹•æ‰“é–‹
                // ç›®å‰ç¶­æŒç¾ç‹€ï¼Œåªæ›´æ–°ä½ˆå±€
                updateLayout();
            });

            // é»æ“Šä¸»å…§å®¹å€è‡ªå‹•é—œé–‰å´é‚Šæ¬„
            mainContent.addEventListener('click', function() {
                if (sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    updateLayout();
                }
            });

            // åˆå§‹åŒ–
            setInitialSidebarState();
        });

        let selectedFile = null;
        let cameraStream = null;
        let isCameraOn = false;



        // é¡¯ç¤ºé—œæ–¼è³‡è¨Š
        function showAbout() {
            // æ‰‹æ©Ÿç‰ˆå…ˆé—œé–‰å´é‚Šæ¬„
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
            
            const aboutText = `
ğŸ”§ 3D å°è¡¨æ©Ÿç¶²é æ§åˆ¶ç³»çµ±

ã€åŠŸèƒ½ç°¡ä»‹ã€‘

â€¢ å³æ™‚ç›£æ§ï¼š
  - å™´å˜´èˆ‡ç†±åºŠæº«åº¦å³æ™‚é¡¯ç¤º
  - åˆ—å°é€²åº¦è¿½è¹¤
  - è€—æé‡é‡èˆ‡å‰©é¤˜æ™‚é–“é¡¯ç¤º

â€¢ é ç«¯æ§åˆ¶ï¼š
  - ä¸Šå‚³ G-code æª”æ¡ˆ
  - é–‹å§‹/æš«åœ/åœæ­¢åˆ—å°
  - æº«åº¦è¨­å®š
  - ç·Šæ€¥åœæ­¢åŠŸèƒ½

â€¢ è¦–è¨Šç›£æ§ï¼š
  - USB æ”å½±æ©Ÿå³æ™‚ä¸²æµ
  - é ç«¯ç›£æ§åˆ—å°ç‹€æ³

ã€ç³»çµ±æ¶æ§‹ã€‘
ç€è¦½å™¨ â†” Flask å¾Œç«¯ â†” ESP32 â†” STM32 â†” 3D å°è¡¨æ©Ÿ

ã€æŠ€è¡“å ±é»ã€‘
- å‰ç«¯ï¼šHTML/CSS/JavaScript
- å¾Œç«¯ï¼šPython Flask + WebSocket
- ç¡¬é«”ï¼šESP32 + STM32
- é€šè¨Šï¼šWebSocket å³æ™‚é›™å‘å‚³è¼¸
            `.trim();
            alert(aboutText);
        }

        // é¡¯ç¤º QR Code
        function showQRCode() {
            // æ‰‹æ©Ÿç‰ˆå…ˆé—œé–‰å´é‚Šæ¬„
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
            
            // å»ºç«‹é®ç½©å±¤
            const overlay = document.createElement('div');
            overlay.className = 'settings-overlay show';
            overlay.id = 'qrcodeOverlay';
            
            // å»ºç«‹ QR Code è¦–çª—
            overlay.innerHTML = `
                <div class="settings-modal" style="text-align: center;">
                    <h3>ğŸ”— æƒæ QR Code é€£ç·š</h3>
                    <div id="qrcodeContainer" style="margin: 20px auto; display: flex; justify-content: center; align-items: center; background: white; padding: 20px; border-radius: 8px; min-height: 296px;">
                        <div style="color: #666;">æ­£åœ¨ç²å–ä¼ºæœå™¨ IP...</div>
                    </div>
                    <div id="serverURL" style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px; word-break: break-all;">
                    </div>
                    <div class="settings-buttons" style="justify-content: center;">
                        <button class="btn-primary" onclick="closeQRCode()">é—œé–‰</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // å¾å¾Œç«¯ç²å–ä¼ºæœå™¨ IP
            fetch('/get_server_ip')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const serverURL = data.url;
                        document.getElementById('serverURL').textContent = serverURL;
                        
                        const container = document.getElementById('qrcodeContainer');
                        if (container) {
                            const qrImage = document.createElement('img');
                            qrImage.style.width = '256px';
                            qrImage.style.height = '256px';
                            qrImage.style.display = 'block';
                            
                            // ä½¿ç”¨ api.qrserver.com
                            qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(serverURL)}`;
                            
                            qrImage.onerror = function() {
                                // å¦‚æœå¤±æ•—ï¼Œé¡¯ç¤ºå¯è¤‡è£½çš„é€£çµ
                                container.innerHTML = `
                                    <div style="padding: 20px; color: #333; text-align: center;">
                                        <p style="margin-bottom: 15px; font-weight: 600; font-size: 1.1rem;">ç„¡æ³•ç”Ÿæˆ QR Code</p>
                                        <p style="font-size: 0.9rem; margin-bottom: 10px;">è«‹è¤‡è£½ä»¥ä¸‹ç¶²å€åˆ†äº«ï¼š</p>
                                        <input type="text" value="${serverURL}" readonly 
                                            style="width: 100%; padding: 12px; margin-top: 10px; border: 2px solid #ddd; border-radius: 6px; color: #000; font-size: 0.9rem;"
                                            onclick="this.select(); document.execCommand('copy'); alert('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');" />
                                    </div>
                                `;
                            };
                            
                            container.innerHTML = '';
                            container.appendChild(qrImage);
                        }
                    } else {
                        document.getElementById('qrcodeContainer').innerHTML = `
                            <p style="color: #ef4444;">ç„¡æ³•ç²å–ä¼ºæœå™¨ IP</p>
                        `;
                    }
                })
                .catch(error => {
                    document.getElementById('qrcodeContainer').innerHTML = `
                        <p style="color: #ef4444;">éŒ¯èª¤: ${error.message}</p>
                    `;
                });
            
            // é»æ“Šé®ç½©å±¤é—œé–‰
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeQRCode();
                }
            });
        }

        // é—œé–‰ QR Code è¦–çª—
        function closeQRCode() {
            const overlay = document.getElementById('qrcodeOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // é¡¯ç¤ºè¨­å®šè¦–çª—
        function showSettings() {
            // æ‰‹æ©Ÿç‰ˆå…ˆé—œé–‰å´é‚Šæ¬„
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
            
            // å»ºç«‹é®ç½©å±¤
            const overlay = document.createElement('div');
            overlay.className = 'settings-overlay show';
            overlay.id = 'settingsOverlay';
            
            // å»ºç«‹è¨­å®šè¦–çª—
            const modal = document.createElement('div');
            modal.className = 'settings-modal';
            
            const title = document.createElement('h3');
            title.textContent = 'âš¡ ESP32 IP è¨­å®š';
            modal.appendChild(title);
            
            // IP è¼¸å…¥å®¹å™¨
            const ipContainer = document.createElement('div');
            ipContainer.className = 'ip-input-container';
            
            const span1 = document.createElement('span');
            span1.textContent = 'ws://192.168.';
            ipContainer.appendChild(span1);
            
            const ip3Input = document.createElement('input');
            ip3Input.type = 'number';
            ip3Input.id = 'ip3';
            ip3Input.min = '0';
            ip3Input.max = '255';
            ip3Input.placeholder = '...';
            ipContainer.appendChild(ip3Input);
            
            const span2 = document.createElement('span');
            span2.textContent = '.';
            ipContainer.appendChild(span2);
            
            const ip4Input = document.createElement('input');
            ip4Input.type = 'number';
            ip4Input.id = 'ip4';
            ip4Input.min = '0';
            ip4Input.max = '255';
            ip4Input.placeholder = '...';
            ipContainer.appendChild(ip4Input);
            
            const span3 = document.createElement('span');
            span3.textContent = ':';
            ipContainer.appendChild(span3);
            
            const portInput = document.createElement('input');
            portInput.type = 'number';
            portInput.id = 'port';
            portInput.min = '1';
            portInput.max = '65535';
            portInput.placeholder = '...';
            ipContainer.appendChild(portInput);
            
            modal.appendChild(ipContainer);

            // åˆ†éš”ç·š
            const divider = document.createElement('hr');
            divider.style.cssText = 'border: none; border-top: 1px solid var(--border-color); margin: 20px 0;';
            modal.appendChild(divider);

            // é¡é ­ä¾†æºé¸é …
            const cameraTitle = document.createElement('h4');
            cameraTitle.textContent = 'ğŸ“· é¡é ­ä¾†æº';
            cameraTitle.style.cssText = 'color: var(--text-primary); margin-bottom: 15px; font-size: 1.1rem;';
            modal.appendChild(cameraTitle);

            const cameraContainer = document.createElement('div');
            cameraContainer.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 20px;';

            const cameraLabel = document.createElement('span');
            cameraLabel.textContent = 'å¾ä»¥ä¸‹ä¾†æºé–‹å•Ÿé¡é ­ï¼š';
            cameraLabel.style.cssText = 'color: var(--text-secondary);';
            cameraContainer.appendChild(cameraLabel);

            const cameraSelect = document.createElement('select');
            cameraSelect.id = 'cameraSource';
            cameraSelect.style.cssText = 'padding: 10px 15px; font-size: 1rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--dark-surface); color: var(--accent-color); font-weight: 600; cursor: pointer;';

            const optionEsp32 = document.createElement('option');
            optionEsp32.value = 'esp32';
            optionEsp32.textContent = 'ESP32';
            cameraSelect.appendChild(optionEsp32);

            const optionServer = document.createElement('option');
            optionServer.value = 'server';
            optionServer.textContent = 'ä¼ºæœå™¨';
            cameraSelect.appendChild(optionServer);

            cameraContainer.appendChild(cameraSelect);
            modal.appendChild(cameraContainer);
            
            // æŒ‰éˆ•å®¹å™¨
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'settings-buttons';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn-primary';
            saveBtn.textContent = 'ç¢ºå®š';
            saveBtn.onclick = saveESP32IP;
            buttonsDiv.appendChild(saveBtn);
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn-danger';
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.onclick = closeSettings;
            buttonsDiv.appendChild(cancelBtn);
            
            modal.appendChild(buttonsDiv);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // é»æ“Šé®ç½©å±¤é—œé–‰
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeSettings();
                }
            });

            // å¾å¾Œç«¯è®€å–ç›®å‰çš„é…ç½®ï¼Œä¸¦åœ¨è¼‰å…¥å®Œæˆå¾Œç¶å®š Enter éµ
            fetch('/get_config')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.esp32_ip) {
                        // è§£æ IP: ws://192.168.X.Y:PORT
                        const regex = /ws:\/\/192\.168\.(\d+)\.(\d+):(\d+)/;
                        const match = data.esp32_ip.match(regex);
                        
                        if (match) {
                            document.getElementById('ip3').value = match[1];
                            document.getElementById('ip4').value = match[2];
                            document.getElementById('port').value = match[3];
                        } else {
                            console.warn("ç„¡æ³•è§£æç›®å‰çš„ IP æ ¼å¼:", data.esp32_ip);
                        }
                    }

                    // è¨­å®šé¡é ­ä¾†æºé¸å–®
                    if (data.camera_source) {
                        var cameraSourceEl = document.getElementById('cameraSource');
                        if (cameraSourceEl) {
                            cameraSourceEl.value = data.camera_source;
                        }
                    }

                    // åœ¨è³‡æ–™è¼‰å…¥å¾Œç¶å®š Enter éµäº‹ä»¶
                    bindEnterKey();
                })
                .catch(err => {
                    console.error("è®€å–é…ç½®å¤±æ•—:", err);
                    // å³ä½¿è®€å–å¤±æ•—ä¹Ÿè¦ç¶å®š Enter éµ
                    bindEnterKey();
                });
            
            // ç¶å®š Enter éµçš„å‡½æ•¸
            function bindEnterKey() {
                const inputs = ['ip3', 'ip4', 'port'];
                inputs.forEach(function(id) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('keydown', function (e) {
                            if (e.key === 'Enter' || e.keyCode === 13) {
                                e.preventDefault();
                                e.stopPropagation();
                                saveESP32IP();
                                return false;
                            }
                        });
                    }
                });
            }
        }

        // é—œé–‰è¨­å®šè¦–çª—
        function closeSettings() {
            const overlay = document.getElementById('settingsOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // å„²å­˜ ESP32 IP
        function saveESP32IP() {
            try {
                const ip3El = document.getElementById('ip3');
                const ip4El = document.getElementById('ip4');
                const portEl = document.getElementById('port');
                
                // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!ip3El || !ip4El || !portEl) {
                    console.error('ç„¡æ³•æ‰¾åˆ°è¼¸å…¥æ¬„ä½');
                    return;
                }
                
                const ip3 = ip3El.value.trim();
                const ip4 = ip4El.value.trim();
                const port = portEl.value.trim();
                
                // é©—è­‰è¼¸å…¥ä¸ç‚ºç©º
                if (!ip3 || !ip4 || !port) {
                    closeSettings();
                    return;
                }
                
                // è½‰æ›ç‚ºæ•¸å­—é€²è¡Œé©—è­‰
                const ip3Num = parseInt(ip3);
                const ip4Num = parseInt(ip4);
                const portNum = parseInt(port);
                
                // é©—è­‰æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—
                if (isNaN(ip3Num) || isNaN(ip4Num) || isNaN(portNum)) {
                    alert('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—');
                    return;
                }
                
                // é©—è­‰è¼¸å…¥ç¯„åœ
                if (ip3Num < 0 || ip3Num > 255 || ip4Num < 0 || ip4Num > 255) {
                    alert('âŒ IP ä½å€ç¯„åœå¿…é ˆåœ¨ 0-255 ä¹‹é–“');
                    return;
                }
                
                if (portNum < 1 || portNum > 65535) {
                    alert('âŒ åŸ è™Ÿç¯„åœå¿…é ˆåœ¨ 1-65535 ä¹‹é–“');
                    return;
                }
                
                const newIP = 'ws://192.168.' + ip3Num + '.' + ip4Num + ':' + portNum;

                // å–å¾—é¡é ­ä¾†æºè¨­å®š
                var cameraSourceEl = document.getElementById('cameraSource');
                var cameraSource = cameraSourceEl ? cameraSourceEl.value : 'esp32';
                
                // ç™¼é€è«‹æ±‚æ›´æ–° ESP32 IP
                fetch('/update_esp32_ip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ip: newIP })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ç¹¼çºŒå„²å­˜é¡é ­ä¾†æº
                        return fetch('/update_camera_source', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ source: cameraSource })
                        });
                    } else {
                        throw new Error(data.error || 'æ›´æ–° IP å¤±æ•—');
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('âœ… è¨­å®šå·²å„²å­˜\nESP32 IP: ' + newIP + '\né¡é ­ä¾†æº: ' + (cameraSource === 'esp32' ? 'ESP32' : 'ä¼ºæœå™¨') + '\n\nè«‹ç¨å€™ï¼Œç³»çµ±æ­£åœ¨é‡æ–°é€£ç·š...');
                        closeSettings();
                        setTimeout(function() { location.reload(); }, 1000);
                    } else {
                        throw new Error(data.error || 'æ›´æ–°é¡é ­ä¾†æºå¤±æ•—');
                    }
                })
                .catch(error => {
                    console.error('æ›´æ–°è¨­å®šéŒ¯èª¤:', error);
                    alert('âŒ éŒ¯èª¤: ' + error.message);
                });
            } catch (error) {
                console.error('saveESP32IP ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // é¸æ“‡æª”æ¡ˆ
        document.getElementById('actionButton').addEventListener('click', function () {
            document.getElementById('fileInput').click();
        });



        document.getElementById('fileInput').addEventListener('change', function (event) {
            const fileNameElement = document.getElementById('fileName');
            if (event.target.files.length > 0) {
                const file = event.target.files[0];
                const fileName = file.name.toLowerCase();
                
                // é©—è­‰å‰¯æª”å
                if (fileName.endsWith('.gcode') || fileName.endsWith('.gco')) {
                    selectedFile = file;
                    fileNameElement.textContent = 'é¸æ“‡çš„æª”æ¡ˆ: ' + file.name;
                    fileNameElement.style.color = 'var(--accent-color)';
                } else {
                    selectedFile = null;
                    fileNameElement.textContent = 'éŒ¯èª¤ï¼šåªå…è¨± .gcode æˆ– .gco æª”æ¡ˆ';
                    fileNameElement.style.color = 'var(--danger-color)';
                    event.target.value = ''; // æ¸…é™¤æª”æ¡ˆé¸æ“‡
                }
            } else {
                selectedFile = null;
                fileNameElement.textContent = 'æœªé¸æ“‡æª”æ¡ˆ';
            }
        });

        // ä¸Šå‚³æª”æ¡ˆ
        document.getElementById('uploadButton').addEventListener('click', function () {
            if (!selectedFile) {
                document.getElementById('uploadStatus').textContent = 'è«‹å…ˆé¸æ“‡æª”æ¡ˆ';
                return;
            }

            // å†æ¬¡é©—è­‰å‰¯æª”å
            const fileName = selectedFile.name.toLowerCase();
            if (!fileName.endsWith('.gcode') && !fileName.endsWith('.gco')) {
                document.getElementById('uploadStatus').textContent = 'éŒ¯èª¤ï¼šåªå…è¨±ä¸Šå‚³ .gcode æˆ– .gco æª”æ¡ˆ';
                return;
            }

            if (ws.readyState === WebSocket.OPEN) {
                ws.send('cStartTransmission');
                document.getElementById('uploadStatus').textContent = 'ç­‰å¾… ESP32 å›è¦† STM ok...';
            } else {
                document.getElementById('uploadStatus').textContent = 'WebSocket æœªé€£ç·šï¼Œç„¡æ³•ä¸Šå‚³';
            }
        });

        // é–‹å§‹åˆ—å°
        document.getElementById('startPrintButton').addEventListener('click', function () {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send("cStartToPrint");
                document.getElementById('uploadStatus').textContent = "å·²é€å‡ºé–‹å§‹åˆ—å°æŒ‡ä»¤";
            } else {
                document.getElementById('uploadStatus').textContent = "WebSocket æœªé€£ç·šï¼Œç„¡æ³•é€å‡ºæŒ‡ä»¤";
            }
        });

        // æš«åœåˆ—å°
        document.getElementById('pausePrintButton').addEventListener('click', function () {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send("cPausePrinting");
                document.getElementById('uploadStatus').textContent = "å·²é€å‡ºæš«åœåˆ—å°æŒ‡ä»¤";
            } else {
                document.getElementById('uploadStatus').textContent = "WebSocket æœªé€£ç·šï¼Œç„¡æ³•é€å‡ºæŒ‡ä»¤";
            }
        });

        // åœæ­¢åˆ—å°
        document.getElementById('cstopPrintingButton').addEventListener('click', function () {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send("cStopPrinting");
                document.getElementById('uploadStatus').textContent = "å·²é€å‡ºåœæ­¢åˆ—å°æŒ‡ä»¤";
            } else {
                document.getElementById('uploadStatus').textContent = "WebSocket æœªé€£ç·šï¼Œç„¡æ³•é€å‡ºæŒ‡ä»¤";
            }
        });

        // å›åŸé»
        document.getElementById('homeButton').addEventListener('click', function () {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send("cGoHome");
                document.getElementById('uploadStatus').textContent = "å·²é€å‡ºå›åŸé»æŒ‡ä»¤";
            } else {
                document.getElementById('uploadStatus').textContent = "WebSocket æœªé€£ç·šï¼Œç„¡æ³•é€å‡ºæŒ‡ä»¤";
            }
        });

        // ç·Šæ€¥åœæ­¢
        document.getElementById('emergencyStopButton').addEventListener('click', function () {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send("cEmergencyStop");
                document.getElementById('uploadStatus').textContent = "å·²é€å‡ºç·Šæ€¥åœæ­¢æŒ‡ä»¤";
            } else {
                document.getElementById('uploadStatus').textContent = "WebSocket æœªé€£ç·šï¼Œç„¡æ³•é€å‡ºç·Šæ€¥åœæ­¢æŒ‡ä»¤";
            }
        });

        // è¨­å®šå™´å˜´æº«åº¦
        document.getElementById('setNozzleTempButton').addEventListener('click', function () {
            const temp = document.getElementById('nozzleTempInput').value;
            if (!temp) {
                document.getElementById('uploadStatus').textContent = "è«‹è¼¸å…¥å™´å˜´æº«åº¦";
                return;
            }
            if (ws.readyState === WebSocket.OPEN) {
                ws.send("cSetNozzleTemp<" + temp + ">");
                document.getElementById('uploadStatus').textContent = "å·²é€å‡ºå™´å˜´æº«åº¦è¨­å®š: " + temp + "Â°C";
                // ç«‹å³æ›´æ–°é¡¯ç¤ºçš„æº«åº¦
                document.getElementById('nozzleTempDisplay').textContent = temp + " Â°C";
            } else {
                document.getElementById('uploadStatus').textContent = "WebSocket æœªé€£ç·šï¼Œç„¡æ³•é€å‡ºè¨­å®š";
            }
        });

        // è¨­å®šç†±åºŠæº«åº¦
        document.getElementById('setBedTempButton').addEventListener('click', function () {
            const temp = document.getElementById('bedTempInput').value;
            if (!temp) {
                document.getElementById('uploadStatus').textContent = "è«‹è¼¸å…¥ç†±åºŠæº«åº¦";
                return;
            }
            if (ws.readyState === WebSocket.OPEN) {
                ws.send("cSetBedTemp<" + temp + ">");
                document.getElementById('uploadStatus').textContent = "å·²é€å‡ºç†±åºŠæº«åº¦è¨­å®š: " + temp + "Â°C";
                // ç«‹å³æ›´æ–°é¡¯ç¤ºçš„æº«åº¦
                document.getElementById('bedTempDisplay').textContent = temp + " Â°C";
            } else {
                document.getElementById('uploadStatus').textContent = "WebSocket æœªé€£ç·šï¼Œç„¡æ³•é€å‡ºè¨­å®š";
            }
        });

        // é–‹å•Ÿé¡é ­
        document.getElementById('startCameraButton').addEventListener('click', function () {
            if (!isCameraOn) {
                startCamera();
            } else {
                document.getElementById('cameraStatus').textContent = "é¡é ­å·²ç¶“é–‹å•Ÿ";
            }
        });

        // é—œé–‰é¡é ­
        document.getElementById('stopCameraButton').addEventListener('click', function () {
            if (isCameraOn) {
                stopCamera();
            } else {
                document.getElementById('cameraStatus').textContent = "é¡é ­å·²ç¶“é—œé–‰";
            }
        });

        // é–‹å•Ÿé¡é ­åŠŸèƒ½ - é€šéWebSocketç™¼é€æŒ‡ä»¤
        // é–‹å•Ÿé¡é ­åŠŸèƒ½ - æ ¹æ“šè¨­å®šé¸æ“‡ä¾†æº
        function startCamera() {
            const cameraImg = document.getElementById('cameraStream');
            const cameraStatus = document.getElementById('cameraStatus');

            if (isCameraOn) {
                cameraStatus.textContent = "é¡é ­å·²ç¶“é–‹å•Ÿ";
                console.log("é¡é ­å·²ç¶“é–‹å•Ÿ,ä¸é‡è¤‡é–‹å•Ÿ");
                return;
            }

            console.log("=== é–‹å•Ÿé¡é ­ ===");

            // å¾å¾Œç«¯å–å¾—é…ç½®ä¸¦æ±ºå®šé¡é ­ä¾†æº
            fetch('/get_config')
                .then(response => response.json())
                .then(configData => {
                    var cameraSource = configData.camera_source || 'esp32';
                    console.log("é¡é ­ä¾†æºè¨­å®š:", cameraSource);

                    if (cameraSource === 'server') {
                        // ä½¿ç”¨ä¼ºæœå™¨çš„ USB æ”å½±æ©Ÿï¼Œç™¼é€é–‹å•ŸæŒ‡ä»¤çµ¦å¾Œç«¯ä¼ºæœå™¨ï¼ˆä¸æ˜¯ ESP32ï¼‰
                        console.log("ä½¿ç”¨ä¼ºæœå™¨ USB æ”å½±æ©Ÿ");
                        if (typeof ws !== 'undefined' && ws.readyState === WebSocket.OPEN) {
                            ws.send('cEnableServerCamera');
                            console.log("âœ“ å·²ç™¼é€ cEnableServerCamera æŒ‡ä»¤åˆ°å¾Œç«¯");
                        }
                        var serverVideoUrl = window.location.protocol + '//' + window.location.host + '/video_feed';
                        console.log("ä½¿ç”¨ä¼ºæœå™¨ä¸²æµ URL:", serverVideoUrl);
                        cameraImg.src = serverVideoUrl;
                    } else {
                        // ä½¿ç”¨ ESP32 çš„ä¸²æµï¼Œç™¼é€é–‹å•ŸæŒ‡ä»¤
                        if (typeof ws !== 'undefined' && ws.readyState === WebSocket.OPEN) {
                            ws.send('cEnableCamera');
                            console.log("âœ“ å·²ç™¼é€ cEnableCamera æŒ‡ä»¤åˆ°å¾Œç«¯");
                        } else {
                            console.warn("âš  WebSocket æœªé€£ç·šï¼Œä½†ä»å¯å˜—è©¦é–‹å•Ÿä¸²æµ");
                        }
                        
                        fetch('/get_esp32_camera_url')
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    console.log("ä½¿ç”¨ ESP32 ä¸²æµ URL:", data.url);
                                    cameraImg.src = data.url;
                                } else {
                                    console.error("ç„¡æ³•ç²å– ESP32 ä¸²æµ URL");
                                    cameraStatus.textContent = "ç„¡æ³•ç²å–ä¸²æµç¶²å€";
                                }
                            })
                            .catch(err => {
                                console.error("å–å¾— ESP32 ä¸²æµ URL å¤±æ•—:", err);
                                cameraStatus.textContent = "å–å¾—ä¸²æµç¶²å€å¤±æ•—";
                            });
                    }
                })
                .catch(err => {
                    console.error("è®€å–é…ç½®å¤±æ•—:", err);
                    // é è¨­ä½¿ç”¨ ESP32
                    if (typeof ws !== 'undefined' && ws.readyState === WebSocket.OPEN) {
                        ws.send('cEnableCamera');
                    }
                    fetch('/get_esp32_camera_url')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                cameraImg.src = data.url;
                            }
                        });
                });

            cameraImg.style.display = 'block';
            cameraStatus.textContent = "æ­£åœ¨é€£æ¥è¦–è¨Šä¸²æµ...";
            isCameraOn = true;
            console.log("isCameraOn è¨­ç‚º true");

            // ç›£è½åœ–ç‰‡è¼‰å…¥æˆåŠŸ
            cameraImg.onload = function () {
                cameraStatus.textContent = "é¡é ­å·²é–‹å•Ÿ";
                console.log("âœ“ è¦–è¨Šä¸²æµå·²æˆåŠŸé€£æ¥");
            };

            // ç›£è½åœ–ç‰‡è¼‰å…¥å¤±æ•—
            cameraImg.onerror = function () {
                console.error("âœ— ç„¡æ³•è¼‰å…¥è¦–è¨Šä¸²æµ");
                cameraStatus.textContent = "è¦–è¨Šä¸²æµé€£æ¥å¤±æ•—";
            };
            
            console.log("=== é–‹å•Ÿé¡é ­å®Œæˆ ===");
        }

        // é—œé–‰é¡é ­åŠŸèƒ½ - é€šéWebSocketç™¼é€æŒ‡ä»¤
        function stopCamera() {
            const cameraImg = document.getElementById('cameraStream');
            const cameraStatus = document.getElementById('cameraStatus');

            if (!isCameraOn) {
                cameraStatus.textContent = "é¡é ­å·²ç¶“é—œé–‰";
                console.log("é¡é ­å·²ç¶“é—œé–‰,ä¸é‡è¤‡é—œé–‰");
                return;
            }

            console.log("=== é—œé–‰é¡é ­ ===");

            // å¾å¾Œç«¯å–å¾—é…ç½®ï¼Œæ ¹æ“šä¾†æºç™¼é€å°æ‡‰çš„é—œé–‰æŒ‡ä»¤
            fetch('/get_config')
                .then(response => response.json())
                .then(configData => {
                    var cameraSource = configData.camera_source || 'esp32';
                    if (cameraSource === 'esp32') {
                        // ä½¿ç”¨ ESP32 æ™‚ç™¼é€é—œé–‰æŒ‡ä»¤çµ¦ ESP32
                        if (typeof ws !== 'undefined' && ws.readyState === WebSocket.OPEN) {
                            ws.send('cDisableCamera');
                            console.log("âœ“ å·²ç™¼é€ cDisableCamera æŒ‡ä»¤åˆ°å¾Œç«¯");
                        }
                    } else {
                        // ä½¿ç”¨ä¼ºæœå™¨ USB æ”å½±æ©Ÿæ™‚ç™¼é€é—œé–‰æŒ‡ä»¤çµ¦ä¼ºæœå™¨
                        if (typeof ws !== 'undefined' && ws.readyState === WebSocket.OPEN) {
                            ws.send('cDisableServerCamera');
                            console.log("âœ“ å·²ç™¼é€ cDisableServerCamera æŒ‡ä»¤åˆ°å¾Œç«¯");
                        }
                    }
                })
                .catch(err => {
                    console.error("è®€å–é…ç½®å¤±æ•—:", err);
                });

            // æ¸…é™¤ srcï¼Œç€è¦½å™¨å°±æœƒåœæ­¢è«‹æ±‚ä¸²æµ
            console.log("æ¸…é™¤è¦–è¨Šä¸²æµ src");
            cameraImg.src = '';

            cameraImg.style.display = 'none';
            cameraStatus.textContent = "é¡é ­å·²é—œé–‰";
            isCameraOn = false;
            console.log("isCameraOn è¨­ç‚º false");
            console.log("=== é—œé–‰é¡é ­å®Œæˆ ===");
        }

        // å‹•æ…‹å»ºç«‹ WebSocket é€£ç·šåˆ° "ç›®å‰è¼‰å…¥ç¶²é çš„ä¼ºæœå™¨"
        // 1. å–å¾—ç›®å‰ç¶²é çš„å”å®š (http: -> ws: æˆ– https: -> wss:)
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        // 2. å–å¾—ç›®å‰çš„ä¸»æ©Ÿå’ŒåŸ è™Ÿ (ä¾‹å¦‚ 192.168.1.10:5000)
        const wsHost = window.location.host;
        // 3. çµ„åˆ Flask ä¼ºæœå™¨ä¸Š @sock.route('/ws') çš„è·¯å¾‘
        const wsUrl = `${wsProtocol}//${wsHost}/ws`;

        console.log("æ­£åœ¨é€£ç·šåˆ° WebSocket ä¼ºæœå™¨:", wsUrl);
        const ws = new WebSocket(wsUrl); // <-- [ æœ€çµ‚é€£ç·š ]

        // è¨˜éŒ„é‡å‚³æ¬¡æ•¸
        let retryCount = 0;

        ws.onopen = function () {
            console.log("å·²æˆåŠŸé€£ç·šåˆ°å¾Œç«¯ Flask ä¼ºæœå™¨"); // æ–‡å­—ä¿®æ”¹
            document.getElementById('connectionStatus').textContent = "å¾Œç«¯å·²é€£ç·š";
            // [ æ¬¡è¦ä¿®æ”¹ ]
            // æ‚¨æœ‰å…©å€‹ ID å« 'connectionStatus'ï¼Œæˆ‘å€‘åœ¨é€™è£¡ä¿®æ­£é€™å€‹å•é¡Œ
            document.getElementById('connectionDot').classList.add('connected');

            // åŒæ™‚æ›´æ–°ã€Œç³»çµ±ç‹€æ…‹ã€å¡ç‰‡ä¸­çš„æ–‡å­—
            const monitorStatus = document.getElementById('monitorConnectionStatus');
            if (monitorStatus) {
                monitorStatus.textContent = "å·²é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œæ­£åœ¨æª¢æŸ¥ ESP32...";
            }
            
            // åˆå§‹åŒ– ESP32 ç‹€æ…‹ç‚ºæœªé€£ç·š
            document.getElementById('esp32Status').textContent = "ESP32 æœªé€£ç·š";
            document.getElementById('esp32Dot').classList.remove('connected');
        };

        ws.onmessage = function (event) {
            console.log("æ”¶åˆ°è¨Šæ¯:", event.data);

            // [æ–°å¢] è™•ç† ESP32 é€£ç·šç‹€æ…‹è¨Šæ¯
            if (event.data === 'ESP32_CONNECTED') {
                document.getElementById('esp32Status').textContent = "ESP32 å·²é€£ç·š";
                document.getElementById('esp32Dot').classList.add('connected');
                
                const monitorStatus = document.getElementById('monitorConnectionStatus');
                if (monitorStatus) {
                    monitorStatus.textContent = "å·²é€£ç·šåˆ° ESP32";
                    monitorStatus.style.color = "var(--accent-color)";
                }
                return;
            } else if (event.data === 'ESP32_DISCONNECTED') {
                document.getElementById('esp32Status').textContent = "ESP32 æœªé€£ç·š";
                document.getElementById('esp32Dot').classList.remove('connected');
                
                const monitorStatus = document.getElementById('monitorConnectionStatus');
                if (monitorStatus) {
                    monitorStatus.textContent = "ESP32 æœªé€£ç·š";
                    monitorStatus.style.color = "var(--danger-color)";
                }
                return;
            }

            const espMessage = document.getElementById('espMessage');
            espMessage.textContent = "ä¼ºæœå™¨è¨Šæ¯: " + event.data;

            if (event.data === 'STM ok') {
                ws.send('cSetFilename<' + selectedFile.name + '>');
                document.getElementById('uploadStatus').textContent = 'ESP32 å·²å›è¦† STM okï¼Œé€å‡ºæª”å...';
            } else if (event.data === 'Name ok') {
                document.getElementById('uploadStatus').textContent = 'ESP32 å·²ç¢ºèªæª”åï¼Œé–‹å§‹ä¸Šå‚³æª”æ¡ˆ...';
                
                // é¡¯ç¤ºé€²åº¦æ¢èˆ‡è½‰åœˆåœˆ
                const progressContainer = document.getElementById('uploadProgressContainer');
                const progressBar = document.getElementById('uploadProgressBar');
                const uploadPercent = document.getElementById('uploadPercent');
                const uploadStatusText = document.getElementById('uploadStatusText');
                
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                uploadPercent.textContent = '0%';
                uploadStatusText.innerHTML = '<div class="spinner"></div>æ­£åœ¨ä¸Šå‚³...';

                const formData = new FormData();
                formData.append('file', selectedFile);

                // ä½¿ç”¨ XMLHttpRequest ä»¥ç›£è½ä¸Šå‚³é€²åº¦
                const xhr = new XMLHttpRequest();
                // å‹•æ…‹ä½¿ç”¨ç•¶å‰ç¶²é çš„ä¸»æ©Ÿä½å€
                const uploadUrl = `${window.location.protocol}//${window.location.host}/upload`;
                xhr.open('POST', uploadUrl, true);

                // ç›£è½ä¸Šå‚³é€²åº¦
                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percentComplete + '%';
                        uploadPercent.textContent = percentComplete + '%';
                        
                        if (percentComplete === 100) {
                            uploadStatusText.innerHTML = '<div class="spinner"></div>ä¼ºæœå™¨è™•ç†ä¸­...';
                        }
                    }
                };

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        console.log('ä¼ºæœå™¨å›æ‡‰:', xhr.responseText);
                        document.getElementById('uploadStatus').textContent = 'æª”æ¡ˆä¸Šå‚³æˆåŠŸ å¯ä»¥é–‹å§‹åˆ—å°';
                        uploadStatusText.innerHTML = 'ä¸Šå‚³å®Œæˆ';
                        progressBar.style.width = '100%';
                        uploadPercent.textContent = '100%';
                        // å»¶é²å¾Œéš±è—é€²åº¦æ¢ (å¯é¸)
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                        }, 3000);
                    } else {
                        console.error('ä¸Šå‚³å¤±æ•—:', xhr.statusText);
                        document.getElementById('uploadStatus').textContent = 'æª”æ¡ˆä¸Šå‚³å¤±æ•—: ' + xhr.status;
                        uploadStatusText.innerHTML = 'ä¸Šå‚³å¤±æ•—';
                        uploadStatusText.style.color = 'var(--danger-color)';
                    }
                };

                xhr.onerror = function() {
                    console.error('ä¸Šå‚³ç™¼ç”ŸéŒ¯èª¤');
                    document.getElementById('uploadStatus').textContent = 'æª”æ¡ˆä¸Šå‚³ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤';
                    uploadStatusText.innerHTML = 'ç¶²è·¯éŒ¯èª¤';
                    uploadStatusText.style.color = 'var(--danger-color)';
                };

                xhr.send(formData);
            } else if (event.data.startsWith("NozzleTemp:")) {
                const temp = event.data.split(":")[1];
                document.getElementById('nozzleTempDisplay').textContent = temp + " Â°C";
            } else if (event.data.startsWith("BedTemp:")) {
                const temp = event.data.split(":")[1];
                document.getElementById('bedTempDisplay').textContent = temp + " Â°C";
            } else if (event.data.startsWith("FilamentWeight:")) {
                const weight = event.data.split(":")[1];
                document.getElementById('filamentWeightDisplay').textContent = weight + " g";
            } else if (event.data.startsWith("RemainingTime:")) {
                const totalSeconds = parseInt(event.data.split(":")[1]);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('remainingTimeDisplay').textContent = timeStr;
            } else if (event.data.startsWith("Progress:")) {
                const progress = event.data.split(":")[1];
                const progressNum = parseFloat(progress);
                document.getElementById('progressDisplay').textContent = progress + " %";
                // åŒæ™‚æ›´æ–°é€²åº¦æ¢
                const progressBar = document.getElementById('printProgressBar');
                if (progressBar) {
                    progressBar.style.width = progressNum + '%';
                }
            }
        };

        ws.onclose = function () {
            console.log("èˆ‡å¾Œç«¯ Flask ä¼ºæœå™¨çš„é€£ç·šå·²ä¸­æ–·");
            document.getElementById('connectionStatus').textContent = "é€£ç·šä¸­æ–·";
            document.getElementById('connectionDot').classList.remove('connected');

            const monitorStatus = document.getElementById('monitorConnectionStatus');
            if (monitorStatus) {
                monitorStatus.textContent = "é€£ç·šä¸­æ–·ï¼Œå˜—è©¦é‡é€£...";
                monitorStatus.style.color = "var(--warning-color)";
            }
            const espMessage = document.getElementById('espMessage');
            espMessage.textContent = "é€£ç·šä¸­æ–·";

            // (æ‚¨å¯ä»¥åœ¨é€™è£¡åŠ å…¥é‡é€£é‚è¼¯)
        };
    </script>
</body>

</html>